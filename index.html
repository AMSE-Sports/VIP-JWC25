<!doctype html>
<html lang="th">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>VIP Check-in • WGP#1</title>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.48.0/dist/umd/supabase.js"></script>

  <style>
    :root {
      --primary:#f37021;
      --border:#e5e7eb;
      --ok:#16a34a;

      --font-base:clamp(18px, 2.4vw, 22px);
      --font-label:clamp(18px, 2.4vw, 22px);
      --font-title:clamp(26px, 3.2vw, 32px);
      --font-note:clamp(15px, 2vw, 18px);
    }

    * { box-sizing:border-box; }

    body {
      margin:0;
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;
      background:#f3f4f6;
      color:#111827;
    }

    /* ===== Header banner (ใหม่) ===== */
    .header img {
      width:100%;
      display:block;
    }

    .page {
  min-height:calc(100vh - 180px);
  display:flex;
  justify-content:center;   /* จัดกลางในแนวนอนเหมือนเดิม */
  align-items:flex-start;   /* เปลี่ยนจาก center → ชิดด้านบน */
  padding:24px 16px 32px;   /* เว้นระยะด้านบน–ล่างเล็กน้อย */
}

    .card {
      width:100%;
      max-width:800px;
      background:#fff;
      border-radius:18px;
      border:1px solid var(--border);
      box-shadow:0 10px 25px rgba(15,23,42,0.08);
      padding:22px 18px 24px;
    }

    @media (min-width:640px) {
      .card {
        padding:26px 32px 28px;
        border-radius:22px;
      }
    }

    .title {
      font-size:var(--font-title);
      font-weight:700;
      text-align:center;
      margin:0 0 4px;
      color:#111827;
    }

    .subtitle {
      font-size:var(--font-base);
      text-align:center;
      margin:0 0 16px;
      color:#4b5563;
    }

    .badge {
      display:inline-flex;
      align-items:center;
      gap:6px;
      padding:4px 10px;
      border-radius:999px;
      background:rgba(243,112,33,0.08);
      color:#b45309;
      font-size:var(--font-note);
      margin:0 auto 10px;
    }

    .badge-dot {
      width:8px;
      height:8px;
      border-radius:999px;
      background:var(--primary);
    }

    .section {
      margin-top:10px;
      border-top:1px dashed var(--border);
      padding-top:12px;
    }

    .section-title {
      font-size:var(--font-label);
      font-weight:700;
      margin-bottom:6px;
      color:#111827;
    }

    .section-caption {
      font-size:var(--font-note);
      color:#6b7280;
      margin-bottom:8px;
    }

    .field {
      margin-bottom:10px;
    }

    label {
      display:block;
      font-size:var(--font-label);
      font-weight:600;
      margin-bottom:4px;
      color:#111827;
    }

    input[type="text"] {
      width:100%;
      padding:10px 12px;
      border-radius:12px;
      border:1px solid var(--border);
      font-size:var(--font-base);
      outline:none;
      background:#f9fafb;
      transition:border-color 0.15s, box-shadow 0.15s, background 0.15s;
    }

    input:focus {
      border-color:var(--primary);
      background:#fff;
      box-shadow:0 0 0 1px rgba(243,112,33,0.08);
    }

    button {
      border:none;
      border-radius:999px;
      font-size:var(--font-base);
      padding:10px 20px;
      cursor:pointer;
      font-weight:600;
      display:inline-flex;
      align-items:center;
      justify-content:center;
      gap:8px;
    }

    .btn-primary {
      background:var(--primary);
      color:#fff;
      min-width:160px;
    }

    .btn-primary[disabled] {
      opacity:0.7;
      cursor:wait;
    }

    .btn-outline {
      background:#fff;
      color:#374151;
      border:1px solid var(--border);
    }

    .btn-ghost {
      background:transparent;
      color:#6b7280;
      border:none;
    }

    .search-row {
      display:flex;
      flex-direction:column;
      gap:8px;
    }

    @media (min-width:640px) {
      .search-row {
        flex-direction:row;
        align-items:flex-end;
      }
    }

    .search-row .field {
      flex:1;
      margin-bottom:0;
    }

    .results {
      margin-top:10px;
      max-height:220px;
      overflow:auto;
      border-radius:12px;
      border:1px solid var(--border);
    }

    .result-item {
      padding:8px 12px;
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:8px;
      cursor:pointer;
      font-size:var(--font-base);
    }

    .result-item:nth-child(odd) {
      background:#f9fafb;
    }

    .result-item:hover {
      background:#fee2d5;
    }

    .result-name {
      font-weight:600;
    }

    .result-org {
      font-size:var(--font-note);
      color:#6b7280;
    }

    .badge-status {
      font-size:var(--font-note);
      padding:2px 8px;
      border-radius:999px;
      border:1px solid var(--border);
      white-space:nowrap;
    }

    .badge-status.ok {
      border-color:var(--ok);
      color:#166534;
      background:#ecfdf5;
    }

    .badge-status.done {
      border-color:#22c55e;
      color:#166534;
      background:#bbf7d0;
    }

    .badge-status.warn {
      border-color:#f97316;
      color:#9a3412;
      background:#ffedd5;
    }

    .vip-card-staff {
      margin-top:12px;
      display:flex;
      gap:16px;
      align-items:flex-start;
      border-radius:14px;
      padding:12px;
      background:#f9fafb;
      border:1px solid var(--border);
    }

    .vip-photo {
      width:140px;
      height:140px;
      border-radius:14px;
      object-fit:cover;
      border:1px solid var(--border);
      background:#e5e7eb;
      flex-shrink:0;
    }

    @media (min-width:768px) {
      .vip-photo {
        width:180px;
        height:180px;
      }
    }

    .vip-info {
      flex:1;
      font-size:var(--font-base);
    }

    .vip-info-row {
      margin-bottom:4px;
    }

    .vip-label {
      font-weight:600;
      margin-right:4px;
    }

    .status-box {
      margin-top:6px;
      padding:6px 10px;
      border-radius:12px;
      font-size:var(--font-note);
    }

    .status-box.warn {
      background:#fffbeb;
      color:#713f12;
      border:1px solid #facc15;
    }

    .status-box.done {
      background:#ecfdf5;
      color:#166534;
      border:1px solid #22c55e;
    }

    .divider {
      border-top:1px dashed #e5e7eb;
      margin:14px 0;
    }

    .consent-box {
      margin-top:8px;
      padding:10px 12px;
      border-radius:12px;
      background:#f9fafb;
      font-size:var(--font-note);
      color:#4b5563;
    }

    .consent-item {
      display:flex;
      align-items:flex-start;
      gap:8px;
      margin-bottom:8px;
    }

    .consent-item input {
      width:18px;
      height:18px;
      margin-top:2px;
      accent-color:var(--primary);
    }

    .consent-note {
      margin-top:4px;
      font-size:var(--font-note);
      color:#6b7280;
      line-height:1.5;
    }

    

    .status-error .status-icon {
      background:#dc2626;
    }

    .status-text-strong {
      font-weight:600;
      margin-bottom:2px;
    }

    .center {
      text-align:center;
      /* FINAL VIEW THEME (ORANGE PREMIUM) */

.final-box {
  background: #fff7ef;
  border: 2px solid #f7a464;
  padding: 26px 20px;
  border-radius: 18px;
  text-align: center;
  box-shadow: 0 6px 20px rgba(243, 112, 33, 0.18);
}

.final-title {
  font-size: clamp(26px, 3vw, 34px);
  font-weight: 900;
  color: #f37021;
  margin-bottom: 6px;
}

.final-caption {
  color: #6b7280;
  font-size: clamp(17px, 2.2vw, 20px);
  margin-bottom: 14px;
}

.success-icon {
  width: 70px;
  height: 70px;
  background: #f37021;
  color: white;
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  margin: 12px auto;
  font-size: 40px;
  font-weight: bold;
  box-shadow: 0 4px 12px rgba(243, 112, 33, 0.4);
}

.success-text-strong {
  font-size: 20px;
  color: #d35400;
  font-weight: 700;
  margin-top: 8px;
}

.final-btn {
  background: linear-gradient(90deg, #f37021, #ff944d);
  color: #fff;
  border-radius: 999px;
  padding: 12px 28px;
  font-size: 20px;
  font-weight: 700;
  border: none;
  cursor: pointer;
  margin-top: 20px;
  box-shadow: 0 4px 12px rgba(243, 112, 33, 0.35);
}

.final-btn:hover {
  opacity: .92;
}
    }
  </style>
</head>
<body>

  <!-- Header Banner -->
  <div class="header">
    <!-- เปลี่ยนชื่อไฟล์ให้ตรงกับของจริงได้ -->
    <img src="Header.png" alt="Thai Airways International WGP#1 Waterjet World Cup 2025">
  </div>

  <div class="page">
    <div class="card">
      <div class="badge">
        <span class="badge-dot"></span>
        <span>VIP Check-in • Staff & Guest View</span>
      </div>

      <h1 class="title">VIP Check-in</h1>
      <p class="subtitle">
        เจ้าหน้าที่ค้นหาชื่อ VIP → ยืนยันจากรูปภาพ → ส่งต่ออุปกรณ์ให้ผู้รับ VIP กดยินยอมและรับสิทธิ
      </p>

      <!-- STATE 1: SEARCH & STAFF VIEW -->
      <div id="view-search">
        <div class="section">
          <div class="section-title">ส่วนที่ 1 • เจ้าหน้าที่หน้างาน</div>
          <div class="section-caption">
            ค้นหาจากชื่อ–นามสกุล VIP แล้วกดเลือกรายชื่อที่ถูกต้อง
          </div>

          <div class="search-row">
            <div class="field">
              <label for="search_name">ค้นหาชื่อ–นามสกุล VIP</label>
              <input id="search_name" type="text" placeholder="พิมพ์อย่างน้อย 2 ตัวอักษร แล้วกดค้นหา">
            </div>
            <button id="btn-search" class="btn-primary" type="button">ค้นหา</button>
          </div>

          <div id="search-results" class="results" style="display:none;"></div>

          <div id="staff-selected-container"></div>
          <div id="staff-status-container"></div>
        </div>
      </div>

      <!-- STATE 2: GUEST VIEW -->
      <div id="view-guest" style="display:none;">
        <div class="section">
          <div class="section-title">ส่วนที่ 2 • ผู้รับ VIP</div>
          <div class="section-caption">
            กรุณาตรวจสอบข้อมูลด้านล่าง และกดยืนยันการยินยอมและการรับสิทธิ
          </div>

          <div id="guest-info"></div>

          <div class="consent-box">
            <div class="consent-item">
              <input type="checkbox" id="guest-consent">
              <label for="guest-consent">
                ฉันยินยอมให้ผู้จัดงานเก็บและใช้ข้อมูลส่วนบุคคลของฉัน
                เพื่อการจัดงาน การรักษาความปลอดภัย และการติดต่อสื่อสารที่เกี่ยวข้องกับงานนี้
              </label>
            </div>

            <p class="consent-note">
              โดยการติ๊กถูกและกดปุ่ม <strong>“กดรับสิทธิ”</strong> ฉันยืนยันว่า:
              <br>• ข้อมูลที่ให้ไว้เป็นข้อมูลที่ถูกต้องตามความเป็นจริง
              <br>• ยินยอมให้บันทึกเวลาการรับสิทธิ VIP ไว้ในระบบของผู้จัดงาน
              <br>• เข้าใจว่าการรับสิทธิ VIP ครั้งนี้ใช้ได้สำหรับการออกบัตร / สายข้อมือ ตามจำนวนที่ระบุเท่านั้น
              <br><br>
              ข้อมูลของฉันอาจถูกใช้เพื่อ:
              <br>• การจัดทำสถิติจำนวนผู้เข้าร่วมงานและการรายงานผลการจัดงาน
              <br>• การสื่อสารข้อมูลสำคัญเกี่ยวกับงานนี้ หรือกิจกรรมที่เกี่ยวข้องโดยตรง
              <br>• การรักษาความปลอดภัย การตรวจสอบตัวตน และการป้องกันการใช้สิทธิ์โดยมิชอบ
              <br><br>
              ผู้จัดงานจะเก็บรักษาข้อมูลไว้ในระยะเวลาที่เหมาะสมกับวัตถุประสงค์ของการจัดงาน
              และจะไม่เปิดเผยข้อมูลแก่บุคคลภายนอก นอกจากหน่วยงานหรือคู่ค้าที่เกี่ยวข้องกับงานนี้โดยชอบ
              <br>หากต้องการขอแก้ไข หรือลบข้อมูล สามารถติดต่อเจ้าหน้าที่ผู้จัดงานได้ตามช่องทางที่กำหนด
            </p>
          </div>

          <div id="guest-status-container"></div>

          <div style="margin-top:14px; display:flex; gap:8px; flex-wrap:wrap; justify-content:flex-end;">
            <button type="button" class="btn-ghost" id="btn-back-to-staff">
              กลับให้เจ้าหน้าที่ค้นหาใหม่
            </button>
            <button type="button" class="btn-primary" id="btn-accept">
              <span id="btn-accept-text">กดรับสิทธิ VIP</span>
              <span id="btn-accept-loading" style="display:none;">กำลังบันทึก...</span>
            </button>
          </div>
        </div>
      </div>

      <!-- STATE 3: FINAL VIEW -->
<div id="view-final" style="display:none;">
  <div class="section center final-box">

    <div class="final-title">Ticket Processed</div>
    <p class="final-caption">
      ระบบได้บันทึกการรับสิทธิของคุณเรียบร้อยแล้ว<br>
      กรุณาส่งต่ออุปกรณ์ให้เจ้าหน้าที่ เพื่อดำเนินการออกตั๋ว
    </p>

    <div class="success-icon">✔</div>

    <div class="success-text-strong">
      สำเร็จ • VIP Ticket Processed
    </div>
    <div style="color:#6b7280; margin-top:4px;">
      เจ้าหน้าที่สามารถดำเนินการออกตั๋ว / สายข้อมือ ได้ทันที
    </div>

    <button type="button" class="final-btn" id="btn-back-home">
      กลับไปหน้าแรก
    </button>

  </div>
</div>
      </div>
    </div>
  </div>

<script>
  const SUPABASE_URL = "https://mhecpnqwwxspxfhdvzsc.supabase.co";
  const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im1oZWNwbnF3d3hzcHhmaGR2enNjIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjMwMDc0MjEsImV4cCI6MjA3ODU4MzQyMX0.ONaEMqU6BHuMSywE3Yvtbj78NqBbecI18amsD18Cgnc";

  const supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

  const viewSearch = document.getElementById('view-search');
  const viewGuest = document.getElementById('view-guest');
  const viewFinal = document.getElementById('view-final');

  const searchInput = document.getElementById('search_name');
  const btnSearch = document.getElementById('btn-search');
  const resultsBox = document.getElementById('search-results');
  const staffSelectedContainer = document.getElementById('staff-selected-container');
  const staffStatusContainer = document.getElementById('staff-status-container');

  const guestInfoBox = document.getElementById('guest-info');
  const guestConsent = document.getElementById('guest-consent');
  const btnBackToStaff = document.getElementById('btn-back-to-staff');
  const btnAccept = document.getElementById('btn-accept');
  const btnAcceptText = document.getElementById('btn-accept-text');
  const btnAcceptLoading = document.getElementById('btn-accept-loading');
  const guestStatusContainer = document.getElementById('guest-status-container');

  const btnBackHome = document.getElementById('btn-back-home');

  let currentVip = null;

  function showStaffStatus(type, strongText, message) {
    staffStatusContainer.innerHTML = `
      <div class="status status-${type}">
        <div class="status-icon"></div>
        <div>
          <div class="status-text-strong">${strongText}</div>
          <div>${message}</div>
        </div>
      </div>
    `;
  }

  function showGuestStatus(type, strongText, message) {
    guestStatusContainer.innerHTML = `
      <div class="status status-${type}">
        <div class="status-icon"></div>
        <div>
          <div class="status-text-strong">${strongText}</div>
          <div>${message}</div>
        </div>
      </div>
    `;
  }

  function clearAllStatus() {
    staffStatusContainer.innerHTML = "";
    guestStatusContainer.innerHTML = "";
  }

  async function searchVip() {
    clearAllStatus();
    staffSelectedContainer.innerHTML = "";
    resultsBox.innerHTML = "";
    resultsBox.style.display = "none";

    const keyword = searchInput.value.trim();
    if (keyword.length < 2) {
      showStaffStatus("error", "กรุณาพิมพ์อย่างน้อย 2 ตัวอักษร", "เช่น พิมพ์ชื่อ หรือ นามสกุลบางส่วน แล้วลองค้นหาอีกครั้ง.");
      return;
    }

    btnSearch.disabled = true;
    btnSearch.textContent = "กำลังค้นหา...";

    try {
      const { data, error } = await supabaseClient
        .from('vip_guests')
        .select('*')
        .ilike('full_name', `%${keyword}%`)
        .order('full_name', { ascending: true })
        .limit(50);

      if (error) {
        console.error(error);
        showStaffStatus("error", "ค้นหาข้อมูลไม่สำเร็จ", "ไม่สามารถค้นหา VIP ได้ในขณะนี้ กรุณาลองใหม่.");
        return;
      }

      if (!data || data.length === 0) {
        showStaffStatus("error", "ไม่พบข้อมูล", "ไม่มีรายชื่อ VIP ที่ตรงกับคำค้นนี้.");
        return;
      }

      resultsBox.style.display = "block";
      resultsBox.innerHTML = "";
      data.forEach(vip => {
        const item = document.createElement('div');
        item.className = "result-item";
        item.innerHTML = `
          <div>
            <div class="result-name">${vip.full_name || "-"}</div>
            <div class="result-org">${vip.organization || "-"}</div>
          </div>
          <div class="badge-status ${vip.ticket_processed ? "done" : "ok"}">
            ${vip.ticket_processed ? "Processed" : "Not processed"}
          </div>
        `;
        item.addEventListener('click', () => {
          selectVipForStaff(vip);
        });
        resultsBox.appendChild(item);
      });

    } catch (err) {
      console.error(err);
      showStaffStatus("error", "เกิดข้อผิดพลาด", "ไม่สามารถเชื่อมต่อระบบได้ในขณะนี้.");
    } finally {
      btnSearch.disabled = false;
      btnSearch.textContent = "ค้นหา";
    }
  }

  function selectVipForStaff(vip) {
    currentVip = vip;
    clearAllStatus();

    const processedInfo = vip.ticket_processed
      ? `<div class="status-box done">
           ตั๋วนี้ได้ถูก Processed แล้วเมื่อ ${vip.processed_at ? new Date(vip.processed_at).toLocaleString() : "-"}
         </div>`
      : `<div class="status-box warn">
           ตั๋วนี้ยังไม่ถูก Processed เจ้าหน้าที่สามารถดำเนินการต่อได้
         </div>`;

    staffSelectedContainer.innerHTML = `
      <div class="vip-card-staff">
        <img src="${vip.photo_url || ""}" alt="VIP Photo" class="vip-photo">
        <div class="vip-info">
          <div class="vip-info-row">
            <span class="vip-label">ชื่อ–นามสกุล:</span> ${vip.full_name || "-"}
          </div>
          <div class="vip-info-row">
            <span class="vip-label">หน่วยงาน:</span> ${vip.organization || "-"}
          </div>
          <div class="vip-info-row">
            <span class="vip-label">จำนวนบัตรที่ได้รับ:</span> ${vip.ticket_count || "-"}
          </div>
          ${processedInfo}
          <div class="divider"></div>
          <div style="display:flex; gap:8px; flex-wrap:wrap; justify-content:flex-end; margin-top:6px;">
            <button type="button" class="btn-ghost" id="btn-search-again">ค้นหาใหม่</button>
            <button type="button" class="btn-primary" id="btn-confirm-identity">
              ยืนยันว่าตรงกับบุคคลนี้ → ไปขั้นตอนผู้รับ VIP
            </button>
          </div>
        </div>
      </div>
    `;

    document.getElementById('btn-search-again').addEventListener('click', () => {
      staffSelectedContainer.innerHTML = "";
      searchInput.focus();
    });

    document.getElementById('btn-confirm-identity').addEventListener('click', () => {
      goToGuestView();
    });
  }

  function goToGuestView() {
    if (!currentVip) return;
    clearAllStatus();
    guestConsent.checked = false;

    guestInfoBox.innerHTML = `
      <div class="vip-card-staff" style="border-style:solid;">
        <div class="vip-info">
          <div class="vip-info-row">
            <span class="vip-label">ชื่อ–นามสกุล:</span> ${currentVip.full_name || "-"}
          </div>
          <div class="vip-info-row">
            <span class="vip-label">หน่วยงาน:</span> ${currentVip.organization || "-"}
          </div>
          <div class="vip-info-row">
            <span class="vip-label">จำนวนบัตรที่ได้รับ:</span> ${currentVip.ticket_count || "-"}
          </div>
        </div>
      </div>
    `;

    viewSearch.style.display = "none";
    viewGuest.style.display = "block";
    viewFinal.style.display = "none";
  }

  function backToStaffFromGuest() {
    viewSearch.style.display = "block";
    viewGuest.style.display = "none";
    viewFinal.style.display = "none";
    guestStatusContainer.innerHTML = "";
  }

  function backToHome() {
    currentVip = null;
    searchInput.value = "";
    resultsBox.innerHTML = "";
    resultsBox.style.display = "none";
    staffSelectedContainer.innerHTML = "";
    clearAllStatus();

    viewSearch.style.display = "block";
    viewGuest.style.display = "none";
    viewFinal.style.display = "none";
  }

  async function acceptTicket() {
    clearAllStatus();

    if (!currentVip) {
      showGuestStatus("error", "ไม่พบข้อมูล VIP", "กรุณาให้เจ้าหน้าที่ช่วยค้นหาข้อมูลใหม่อีกครั้ง.");
      return;
    }

    if (!guestConsent.checked) {
      showGuestStatus("error", "กรุณายืนยันการยินยอม", "ต้องติ๊กถูกในช่องยินยอมก่อนจึงจะสามารถกดรับสิทธิได้.");
      return;
    }

    btnAccept.disabled = true;
    btnAcceptLoading.style.display = "inline";
    btnAcceptText.style.display = "none";

    try {
      const nowIso = new Date().toISOString();
      const { data, error } = await supabaseClient
        .from('vip_guests')
        .update({
          ticket_processed: true,
          processed_at: nowIso
        })
        .eq('id', currentVip.id)
        .select()
        .single();

      if (error) {
        console.error(error);
        showGuestStatus("error", "บันทึกไม่สำเร็จ", "ไม่สามารถบันทึกการรับสิทธิได้ กรุณาลองใหม่ หรือให้เจ้าหน้าที่ช่วยตรวจสอบ.");
        return;
      }

      currentVip = data;
      viewSearch.style.display = "none";
      viewGuest.style.display = "none";
      viewFinal.style.display = "block";

    } catch (err) {
      console.error(err);
      showGuestStatus("error", "เกิดข้อผิดพลาด", "ไม่สามารถเชื่อมต่อระบบได้ในขณะนี้.");
    } finally {
      btnAccept.disabled = false;
      btnAcceptLoading.style.display = "none";
      btnAcceptText.style.display = "inline";
    }
  }

  btnSearch.addEventListener('click', searchVip);
  searchInput.addEventListener('keydown', (e) => {
    if (e.key === "Enter") {
      e.preventDefault();
      searchVip();
    }
  });

  btnBackToStaff.addEventListener('click', backToStaffFromGuest);
  btnAccept.addEventListener('click', acceptTicket);
  btnBackHome.addEventListener('click', backToHome);
</script>
</body>
</html>
